<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Batch Correction</title>

    <style>
        body {
            margin: 0;
            min-height: 100vh;
            font-family: Arial, sans-serif;

            background-image: url("/static/background_images/correction.png");
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;

            display: flex;
            justify-content: center;
            align-items: center;
        }

        .page-container {
            width: 100%;
            max-width: 1200px;
            padding: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            color: white;
            text-shadow: 1px 1px 4px black;
            margin-bottom: 20px;
        }

        .image-row {
            display: flex;
            gap: 30px;
            justify-content: center;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        #image-container {
            position: relative;
            display: inline-block;
        }

        img {
            width: 500px;
            border-radius: 6px;
            border: 2px solid #ddd;
        }

        h3 {
            text-align: center;
            color: white;
            text-shadow: 1px 1px 3px black;
        }

        .bbox {
            position: absolute;
            border: 2px dashed;
            pointer-events: none;
        }

        .bbox.chip { border-color: #00ff00; }
        .bbox.void { border-color: #ff3333; }

        .toolbar {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        select, button {
            padding: 8px 16px;
            font-size: 14px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
        }

        button {
            background: #3498db;
            color: white;
        }

        button:hover {
            background: #2980b9;
        }

        button:disabled {
            background: #aaa;
            cursor: not-allowed;
        }

        #progress {
            margin-top: 10px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px black;
        }
    </style>
</head>

<body>
<div class="page-container">

    <h1>Batch Correction</h1>

    <div class="image-row">
        <div>
            <h3>Editable Image</h3>
            <div id="image-container">
                <img id="image">
            </div>
        </div>

        <div>
            <h3>Model Prediction</h3>
            <img id="prediction">
        </div>
    </div>

    <p style="color:white;">Click and drag to draw bounding boxes</p>

    <div class="toolbar">
        <select id="class_id">
            <option value="0">Chip</option>
            <option value="1">Void</option>
        </select>

        <button id="undo-btn" disabled>Undo</button>
        <button id="check-btn">Mark as Checked</button>
        <button id="submit-btn">Submit Image</button>
        <button id="finish-btn" style="display:none;">Finish Batch</button>
    </div>

    <p id="progress"></p>

</div>

<script>
let batchResults = {{ results|tojson }};
let currentIndex = 0;
let currentBoxes = [];
let updates = [];

let firstPoint = null;

const img = document.getElementById("image");
const container = document.getElementById("image-container");
const predictionImg = document.getElementById("prediction");

const undoBtn = document.getElementById("undo-btn");
const submitBtn = document.getElementById("submit-btn");
const checkBtn = document.getElementById("check-btn");
const finishBtn = document.getElementById("finish-btn");
const classSelect = document.getElementById("class_id");
const progressText = document.getElementById("progress");

function getMousePos(e) {
    const rect = img.getBoundingClientRect();
    return {
        x: e.clientX - rect.left,
        y: e.clientY - rect.top
    };
}

function loadImage(index) {
    if (index >= batchResults.length) {
        img.style.display = "none";
        predictionImg.style.display = "none";
        submitBtn.style.display = "none";
        checkBtn.style.display = "none";
        undoBtn.style.display = "none";
        finishBtn.style.display = "inline";
        progressText.textContent = "All images reviewed.";
        return;
    }

    const item = batchResults[index];
    img.src = item.image_url;
    predictionImg.src = item.overlay_url;

    container.querySelectorAll(".bbox").forEach(b => b.remove());
    currentBoxes = [];
    undoBtn.disabled = true;
    firstPoint = null;

    progressText.textContent =
        `Image ${index + 1} of ${batchResults.length}: ${item.filename}`;
}

/* ================================
   TWO-CLICK BOX LOGIC
================================ */

img.onclick = (e) => {
    const pos = getMousePos(e);

    // First click
    if (!firstPoint) {
        firstPoint = pos;
        return;
    }

    // Second click â†’ finalize box
    const secondPoint = pos;

    const scaleX = img.naturalWidth / img.width;
    const scaleY = img.naturalHeight / img.height;

    const bbox = [
        firstPoint.x * scaleX,
        firstPoint.y * scaleY,
        secondPoint.x * scaleX,
        secondPoint.y * scaleY
    ];

    addBox(bbox, parseInt(classSelect.value));
    firstPoint = null;
};

function addBox(bbox, class_id) {
    const [x1, y1, x2, y2] = bbox;

    const scaleX = img.width / img.naturalWidth;
    const scaleY = img.height / img.naturalHeight;

    const div = document.createElement("div");
    div.className = "bbox " + (class_id === 0 ? "chip" : "void");

    div.style.left = Math.min(x1, x2) * scaleX + "px";
    div.style.top = Math.min(y1, y2) * scaleY + "px";
    div.style.width = Math.abs(x2 - x1) * scaleX + "px";
    div.style.height = Math.abs(y2 - y1) * scaleY + "px";

    container.appendChild(div);
    currentBoxes.push({ bbox, class_id, div });
    undoBtn.disabled = false;
}

undoBtn.onclick = () => {
    if (!currentBoxes.length) return;
    currentBoxes.pop().div.remove();
    undoBtn.disabled = currentBoxes.length === 0;
};

submitBtn.onclick = () => {
    const item = batchResults[currentIndex];
    updates.push({
        image_id: item.image_id,
        status: currentBoxes.length ? "corrected" : "skipped",
        correction: {
            chips: currentBoxes.map(c => ({
                bbox: c.bbox,
                class_id: c.class_id
            }))
        }
    });
    loadImage(++currentIndex);
};

checkBtn.onclick = () => {
    const item = batchResults[currentIndex];
    updates.push({
        image_id: item.image_id,
        status: "checked",
        correction: { chips: [] }
    });
    loadImage(++currentIndex);
};

finishBtn.onclick = async () => {
    await fetch("/batch_correct", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            batch_id: batchResults[0].batch_id,
            updates
        })
    });
    alert("Batch saved. Retraining can begin.");
};

loadImage(currentIndex);
</script>

</body>
</html>
