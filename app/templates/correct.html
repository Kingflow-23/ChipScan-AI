<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Batch Correction</title>

    <style>
        body {
            margin: 0;
            min-height: 100vh;
            font-family: Arial, sans-serif;

            background-image: url("/static/background_images/correction.png");
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;

            display: flex;
            justify-content: center;
            align-items: center;
        }

        .top-buttons {
            width: 100%;
            max-width: 1200px;
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .top-buttons button {
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }

        .top-buttons button:hover {
            background-color: #2980b9;
        }

        .page-container {
            width: 100%;
            max-width: 1200px;
            padding: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            color: white;
            text-shadow: 1px 1px 4px black;
            margin-bottom: 20px;
        }

        .image-row {
            display: flex;
            justify-content: center; /* centers the row horizontally */
            gap: 30px;
            margin-bottom: 20px;
        }

        #image-container {
            position: relative;
            display: flex;
            justify-content: center; /* centers canvas and image horizontally */
            align-items: center;     /* centers vertically if container is taller */
            margin: 0 auto;
        }

        #image-container img {
            display: block;
            max-width: 100%;
            border-radius: 6px;
            border: 2px solid #ddd;
        }

        #overlay-canvas {
            position: absolute;
            top: 0;
            left: 0;
        }

        h3 {
            text-align: center;
            color: white;
            text-shadow: 1px 1px 3px black;
        }

        .bbox {
            position: absolute;
            border: 2px dashed;
            pointer-events: none;
        }

        .bbox.chip { border-color: #00ff00; }
        .bbox.void { border-color: #ff3333; }

        .toolbar {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        select, button {
            padding: 8px 16px;
            font-size: 14px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
        }

        button {
            background: #3498db;
            color: white;
        }

        button:hover {
            background: #2980b9;
        }

        button:disabled {
            background: #aaa;
            cursor: not-allowed;
        }

        #progress {
            margin-top: 10px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px black;
        }

        #finish-btn {
            background-color: #8e44ad; /* Purple */
        }

        #finish-btn:hover {
            background-color: #732d91;
        }
    </style>
</head>

<body>
<div class="page-container">

    <h1>Batch Correction</h1>

    <!-- Top Buttons -->
    <div class="top-buttons">
        <button onclick="window.location.href='/'">Run New Prediction</button>
        <button onclick="goToBatchResults()">Back to Batch Results</button>
    </div>


    <div class="image-row" id="image-section">
        <div>
            <h3>Model Prediction (click to correct errors)</h3>
            <div id="image-container">
                <img id="image">
                <canvas id="overlay-canvas"></canvas>
            </div>
        </div>  
    </div>

    <p id="instruction-text" style="color:white;">
        Click and drag to draw bounding boxes
    </p>

    <div class="toolbar" id="toolbar">
        <select id="class_id">
            <option value="0">Chip</option>
            <option value="1">Void</option>
        </select>

        <button id="undo-btn" disabled>Undo</button>
        <button id="submit-btn">Submit Image</button>
    </div>

    <div id="completion-section" style="display:none; text-align:center;">
        <h2 style="color:white; text-shadow:1px 1px 4px black;">
            Batch review completed
        </h2>

        <button id="finish-btn" style="font-size:18px; padding:12px 28px;">
            Proceed to Retraining
        </button>
    </div>

    <p id="progress"></p>

</div>

<script>
let batchResults = {{ results|tojson }};
let currentIndex = 0;
let currentBoxes = [];
let updates = [];

const img = document.getElementById("image");
const canvas = document.getElementById("overlay-canvas");
const ctx = canvas.getContext("2d");

const undoBtn = document.getElementById("undo-btn");
const submitBtn = document.getElementById("submit-btn");
const finishBtn = document.getElementById("finish-btn");
const classSelect = document.getElementById("class_id");
const progressText = document.getElementById("progress");

let firstPoint = null;

// Adjust canvas size when image loads
img.onload = () => {
    canvas.width = img.width;
    canvas.height = img.height;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
};

// Get mouse position relative to canvas
function getMousePos(e) {
    const rect = canvas.getBoundingClientRect();
    return {
        x: e.clientX - rect.left,
        y: e.clientY - rect.top
    };
}

function loadImage(index) {
    if (index >= batchResults.length) {
        document.getElementById("image-section").style.display = "none";
        document.getElementById("toolbar").style.display = "none";
        document.getElementById("instruction-text").style.display = "none";
        progressText.style.display = "none";
        document.getElementById("completion-section").style.display = "block";
        return;
    }

    const item = batchResults[index];
    img.src = item.overlay_url;

    currentBoxes = [];
    firstPoint = null;
    undoBtn.disabled = true;

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    progressText.textContent = `Image ${index + 1} of ${batchResults.length}: ${item.filename}`;
}

// Draw box on canvas
function drawBox(p1, p2, class_id) {
    ctx.strokeStyle = class_id === 0 ? "red" : "yellow";
    ctx.lineWidth = 2;
    ctx.setLineDash([6]);
    ctx.strokeRect(Math.min(p1.x, p2.x), Math.min(p1.y, p2.y),
                   Math.abs(p2.x - p1.x), Math.abs(p2.y - p1.y));
}

// Redraw all current boxes
function redrawBoxes() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    currentBoxes.forEach(b => {
        const p1 = { x: b.bbox[0] / (img.naturalWidth / canvas.width), y: b.bbox[1] / (img.naturalHeight / canvas.height) };
        const p2 = { x: b.bbox[2] / (img.naturalWidth / canvas.width), y: b.bbox[3] / (img.naturalHeight / canvas.height) };
        drawBox(p1, p2, b.class_id);
    });
}

// Canvas click for two-point box creation
canvas.onclick = (e) => {
    const pos = getMousePos(e);

    if (!firstPoint) {
        firstPoint = pos;
        return;
    }

    const secondPoint = pos;
    const scaleX = img.naturalWidth / canvas.width;
    const scaleY = img.naturalHeight / canvas.height;

    const bbox = [
        firstPoint.x * scaleX,
        firstPoint.y * scaleY,
        secondPoint.x * scaleX,
        secondPoint.y * scaleY
    ];

    currentBoxes.push({ bbox, class_id: parseInt(classSelect.value) });
    drawBox(firstPoint, secondPoint, parseInt(classSelect.value));
    firstPoint = null;
    undoBtn.disabled = false;
};

// Undo last box
undoBtn.onclick = () => {
    if (!currentBoxes.length) return;
    currentBoxes.pop();
    redrawBoxes();
    undoBtn.disabled = currentBoxes.length === 0;
};

// Submit current corrections
submitBtn.onclick = () => {
    const item = batchResults[currentIndex];
    updates.push({
        image_id: item.image_id,
        status: currentBoxes.length ? "corrected" : "ok",
        correction: {
            chips: currentBoxes.map(c => ({ bbox: c.bbox, class_id: c.class_id }))
        }
    });
    loadImage(++currentIndex);
};

// Finish batch and send to server
finishBtn.onclick = async () => {
    await fetch("/batch_correct", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ batch_id: batchResults[0].batch_id, updates })
    });

    window.location.href = `/retrain/${batchResults[0].batch_id}`;
};

loadImage(currentIndex);

function goToBatchResults() {
    if (batchResults.length > 0) {
        const batchId = batchResults[0].batch_id;
        window.location.href = `/results/batch/${batchId}`;
    } else {
        alert("No batch data available.");
    }
}
</script>

</body>
</html>
